---
description: 
globs: apps/backend/**/*.ts
alwaysApply: false
---
This backend handles uploading `.srt` subtitle files, scheduling translations to one or more target languages using a job queue, and returning a `.zip` file of translated subtitles when complete. Built with NestJS and deployed using Docker.

## ğŸ“ File Upload Rules
- Accept only `.srt` files.
- Store uploaded files in a structured directory: `uploads/<batch_id>/original/`.
- Each batch of files gets a unique `batch_id` (UUID).
- Enforce max file count (e.g., 10) and max file size (e.g., 5MB per file).

## ğŸ“„ Translation Job Rules
- For each file Ã— target language combination, create a translation job.
- Each job must track:
    - `batch_id`
    - `file_path` (original)
    - `source_lang` (optional, autodetect if blank)
    - `target_lang`
    - `status`: queued, in_progress, done, error
    - `output_path` (set when done)
- Persist job records in Redis.
- Jobs are idempotent: same input should yield same output if reprocessed.

## ğŸ§µ Queue Rules
- All translation jobs are enqueued using the existing event queue.
- One job is created per file Ã— target language.
- After each translation job completes, it must:
    - Update its own status to done
    - Call `checkAndQueueZipJob(batch_id)`
- `checkAndQueueZipJob(batch_id)` performs:
    - A query to count how many translation jobs for that batch are still not done
    - If all jobs are done, it enqueues a single zip job for that batch_id
- The zip job collects all translated `.srt` files for the batch and creates `results.zip`
- The zip file is stored in `uploads/<batch_id>/results.zip`

## ğŸ“¦ Zip File Rules
- Once all translations are complete:
    - Generate a .zip file: `uploads/<batch_id>/results.zip`
    - Include translated files named like `originalname.lang.srt`
- Store final zip under `uploads/<batch_id>/results.zip`.

## ğŸŒ API Rules
- `POST /upload`
    - Accepts multipart upload of `.srt` files + target languages
    - Returns batch_id and status endpoint
- `GET /status/:batch_id`
    - Returns job statuses and zip URL (if available)

## âœ… Validation Rules
- Reject empty uploads or missing target languages
- Ensure no duplicate file names in a batch
- Sanitize filenames for filesystem safety
- Validate language codes using ISO 639-1 format

## Project structure:
```
src/
â”œâ”€â”€ app.module.ts
â”œâ”€â”€ main.ts
â”œâ”€â”€ upload/
â”‚   â”œâ”€â”€ upload.controller.ts
â”‚   â”œâ”€â”€ upload.service.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ queue/
â”‚   â”œâ”€â”€ queue.module.ts
â”‚   â”œâ”€â”€ bullmq.provider.ts
â”‚   â”œâ”€â”€ translation.processor.ts
â”‚   â””â”€â”€ zip.processor.ts
â”œâ”€â”€ gateway/
â”‚   â””â”€â”€ status.gateway.ts
â”œâ”€â”€ redis/
â”‚   â””â”€â”€ redis.module.ts
â”œâ”€â”€ constants/
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ srt.util.ts
â””â”€â”€ services/
    â”œâ”€â”€ file.service.ts
    â”œâ”€â”€ translation.service.ts
    â””â”€â”€ language.service.ts
```

## Step by step implementation
### Step 1: Upload Endpoint
- `upload.controller.ts` handles:
    - Accepting files + target languages
    - Creating a batch ID
    - Saving files to `uploads/<batch_id>/original/`
    - Publishing job metadata to Redis
    - Enqueuing translation jobs via BullMQ

### Step 2: Translation Processor
- `translation.processor.ts` handles:
    - Listening to translation queue
    - Detecting language (once per file)
    - Translating using OpenAI API
    - Writing translated files to uploads/<batch_id>/
    - Updating Redis job status
    - Calling checkAndQueueZipJob(batch_id)

### Step 3: Zip Processor
- `zip.processor.ts` handles:
    - Zipping all translated `.srt` files for a batch_id
    - Saving to `uploads/<batch_id>/results.zip`
    - Publishing a WebSocket event via StatusGateway

### Step 4: WebSocket Gateway
- `status.gateway.ts`:
    - Uses `@WebSocketGateway` with `@SubscribeMessage`
    - Listens to Redis Pub/Sub or job completion hooks
    - Emits jobDone, batchComplete, zipReady

### âœ… Final Touches
- Serve `uploads/` via `ServeStaticModule`
- Add Bull Board UI for `/admin/queues`
- Create utility functions:
  - `checkAndQueueZipJob(batchId)`
  - `detectLanguage(lines: string[])`
  - `translateSrt(lines: string[], targetLang)`

## Deployment
The application is containerized using Docker and can be deployed using docker-compose. The deployment includes:
- NestJS backend service
- Redis for job queue and caching
- Nginx for serving static files and reverse proxy
- SSL/TLS support via Let's Encrypt
